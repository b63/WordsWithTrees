import randomfrom typing import Listimport osimport cairofrom flask import current_app, gfrom flask.cli import with_appcontextimport clickfrom wordstree.graphics.util import Vec, radians, create_dirfrom wordstree.graphics.loader import Loader, FileLoaderIMAGE_DIR = 'wordstree/cache/images'def create_surface(zoom=0):    # name = 'tree_z{}.svg'.format(zoom)    # file = create_img_file(name, path='svg/')    # click.echo('saving svg to {} ...'.format(file.name))    surface = cairo.RecordingSurface(        cairo.Content.COLOR_ALPHA,        cairo.Rectangle(0, 0, Renderer.BASE_WIDTH, Renderer.BASE_HEIGHT)    )    return surfacedef create_img_file(name, path=''):    dir = os.path.join(IMAGE_DIR, path)    create_dir(dir)    pfile = os.path.join(dir, name)    file = open(pfile, mode='wb')    return fileclass Renderer:    BASE_WIDTH = 1024    BASE_HEIGHT = 1024    def __init__(self, max_layers=5):        # self.zoom_levels = [i for i in range(0, max_layers)]        self.zoom_levels = [5, 6, 7, 8, 9, 10, 11]        self.grid_levels = [4, 8, 16, 24, 40, 60, 80]    def setup_canvas(self, ctx):        ctx.scale(Renderer.BASE_WIDTH, Renderer.BASE_HEIGHT)        # draw white background        ctx.set_source_rgb(1, 1, 1)        ctx.rectangle(0, 0, 1, 1)        ctx.fill()        ctx.set_source_rgb(1, 0, 0)        ctx.rectangle(0, 0, 0.01, 0.1)        ctx.fill()        ctx.set_source_rgb(0, 1, 0)        ctx.rectangle(0, 0, 0.1, 0.01)        ctx.fill()        ctx.set_source_rgb(1, 0, 1)        ctx.rectangle(0, 0, 1, 1)        ctx.set_line_width(0.01)        ctx.stroke()        ratio = 0.9        ctx.translate(0.5, 1)        ctx.scale(ratio, ratio)        ctx.translate(-0.5, -1)        # draw boundary        ctx.set_source_rgb(0, 0, 0)        ctx.rectangle(0, 0, 1, 1)        ctx.set_line_width(0.01)        ctx.stroke()    def get_opacity(self, zoom: int, layer: int) -> float:        diff = layer - zoom        if diff <= 0:            return 1.0        elif diff == 1:            return 0.5        elif diff == 2:            return 0.15        elif diff == 3:            return 0.05        else:            return 0    def render_tree(self, loader: Loader, zoom=0):        layers = loader.layers        branches = loader.branches        num_branches = loader.num_branches        surface = create_surface(zoom=zoom)        ctx = cairo.Context(surface)        self.setup_canvas(ctx)        i, layeri = num_branches - 1, len(layers) - 1        next_layer = layers[layeri]        while i >= 0:            opacity = self.get_opacity(zoom, layeri)            if opacity > 0.0:                branches[i].draw(ctx, opacity=opacity)            i -= 1            if i == next_layer:                print('finished drawing layer {:d}...'.format(layeri))                layeri -= 1                next_layer = layers[layeri]        self.save_full_tree(surface, zoom)        self.cache_tiles(surface, zoom)    def save_full_tree(self, surface: cairo.Surface, zoom: int):        svg_file = create_img_file('tree_z{}.svg'.format(zoom), path='svg')        click.echo('Saving svg of tree to {} ...'.format(svg_file.name))        pat = cairo.SurfacePattern(surface)        img = cairo.SVGSurface(svg_file, Renderer.BASE_WIDTH, Renderer.BASE_HEIGHT)        ctx = cairo.Context(img)        ctx.set_source(pat)        ctx.paint()    def cache_tiles(self, surface: cairo.Surface, zoom: int):        pat = cairo.SurfacePattern(surface)        grid = self.grid_levels[zoom]        # dimension of each tile        dimx, dimy = Renderer.BASE_WIDTH, Renderer.BASE_HEIGHT        # dimension of each tile in the original image        grid_dx = Renderer.BASE_WIDTH / grid        grid_dy = Renderer.BASE_HEIGHT / grid        scale = grid_dx / dimx        dir = 'png/zoom_{}'.format(zoom)        for i in range(grid):            x = i * grid_dx            for j in range(grid):                tile = cairo.ImageSurface(cairo.Format.RGB24, dimx, dimy)                ctx = cairo.Context(tile)                y = j * grid_dy                mat = cairo.Matrix(xx=scale, yy=scale, x0=x, y0=y)                pat.set_matrix(mat)                ctx.set_source(pat)                ctx.paint()                file = create_img_file('z{}_{:.0f}x{:.0f}@{}_{}.png'.format(zoom, grid_dx, grid_dy, i, j), path=dir)                click.echo('Saving tile at ({:.2f}, {:.2f}) to {}'.format(x, y, file.name))                tile.write_to_png(file)    @property    def max_zoom_level(self):        return len(self.zoom_levels)-1if __name__ == "__main__":    renderer = Renderer(max_layers=16)    renderer.render_tree(zoom=7)